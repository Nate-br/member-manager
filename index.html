<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Member Savings Manager — Admin</title>

  <!-- Font Awesome + XLSX -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <style>
    :root{
      --primary:#1266f1;
      --muted:#6b7280;
      --success:#16a34a;
      --danger:#dc2626;
      --card:#ffffff;
      --bg: linear-gradient(135deg,#f5f7fb,#e6eef9);
      --radius:12px;
    }
    *{box-sizing:border-box;font-family:"Noto Sans Ethiopic","Segoe UI",Segoe,Arial,sans-serif}
    body{margin:0;background:var(--bg);padding:28px;color:#0f172a}
    .frame{max-width:1200px;margin:0 auto}
    .card{background:var(--card);border-radius:var(--radius);box-shadow:0 6px 24px rgba(15,23,42,0.06);padding:18px}
    header.appbar{display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:18px}
    header.appbar .title{display:flex;flex-direction:column}
    header.appbar h1{margin:0;font-size:1.25rem;color:var(--primary)}
    header.appbar p{margin:0;color:var(--muted);font-size:0.9rem}
    .actions{display:flex;gap:8px;align-items:center}
    .btn{border:0;padding:8px 12px;border-radius:8px;cursor:pointer;font-weight:600;display:inline-flex;align-items:center;gap:8px}
    .btn-primary{background:var(--primary);color:#fff}
    .btn-muted{background:#eef2ff;color:var(--primary)}
    .btn-danger{background:var(--danger);color:#fff}
    .btn-success{background:var(--success);color:#fff}
    .grid{display:grid;grid-template-columns: 1fr 410px;gap:18px}
    @media (max-width:980px){.grid{grid-template-columns:1fr}}
    .panel{display:flex;flex-direction:column;gap:12px}
    .form-row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    label{font-size:0.85rem;color:var(--muted);display:block;margin-bottom:6px}
    input.form-control, select.form-control, textarea.form-control{
      width:100%;padding:10px;border-radius:8px;border:1px solid #e6e9ef;font-size:0.95rem;background:#fff
    }
    .small{font-size:0.85rem;color:var(--muted)}
    .table-wrap{overflow:auto;border-radius:10px}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px 12px;text-align:left;border-bottom:1px solid #f1f5f9;white-space:nowrap}
    th{background:#fbfdff;color:var(--muted);font-weight:700;position:sticky;top:0}
    tr:hover{background:#fbfbfd}
    .muted{color:var(--muted)}
    .controls{display:flex;gap:8px;align-items:center}
    .top-controls{display:flex;justify-content:space-between;align-items:center;gap:8px;margin-bottom:10px}
    .search{flex:1;display:flex;gap:8px}
    .search input{flex:1}
    .checkbox-center{text-align:center}
    .footer-actions{display:flex;gap:8px;justify-content:flex-end;margin-top:10px}
    /* modal */
    .modal-back{position:fixed;inset:0;background:rgba(2,6,23,0.45);display:none;align-items:center;justify-content:center;z-index:1200}
    .modal{background:#fff;border-radius:12px;padding:18px;min-width:320px;max-width:720px;box-shadow:0 8px 40px rgba(2,6,23,0.2)}
    .row{display:flex;gap:8px}
    .form-actions{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}
    .note{font-size:0.85rem;color:var(--muted)}
    .btn-icon{display:inline-flex;align-items:center;justify-content:center;width:36px;height:36px;border-radius:8px}
  </style>
</head>
<body>
  <div class="frame">
    <!-- Admin login card -->
    <div id="loginView" class="card" style="max-width:520px;margin:0 auto">
      <header class="appbar">
        <div class="title">
          <h1>Member Savings Manager (Admin)</h1>
          <p>Vision for a Better Life</p>
        </div>
      </header>
      <form id="loginForm" class="panel">
        <div>
          <label>Username</label>
          <input id="loginUser" class="form-control" value="" autocomplete="username" />
        </div>
        <div>
          <label>Password</label>
          <input id="loginPass" type="password" class="form-control" autocomplete="current-password" />
        </div>
        <div class="footer-actions">
          <button class="btn btn-primary" type="submit"><i class="fa fa-lock"></i> Login</button>
        </div>
        <p class="note">Default credentials: <strong>admin / admin123</strong>. Change them in Settings after login.</p>
      </form>
    </div>

    <!-- Main app -->
    <div id="appView" style="display:none">
      <div class="card">
        <header class="appbar">
          <div class="title">
            <h1>Member Savings Manager</h1>
            <p>Manage members — Import Excel will keep Amharic headers exactly as in the file (supports two header rows).</p>
          </div>
          <div class="actions">
            <button id="btnImport" class="btn btn-muted"><i class="fa fa-file-import"></i> Import Excel</button>
            <button id="btnExport" class="btn btn-primary"><i class="fa fa-file-export"></i> Export Excel</button>
            <button id="btnSettings" class="btn btn-muted"><i class="fa fa-cog"></i> Settings</button>
            <button id="btnLogout" class="btn btn-danger"><i class="fa fa-sign-out-alt"></i> Logout</button>
          </div>
        </header>

        <div class="grid">
          <!-- Left: table and controls -->
          <div class="panel">
            <div class="card" style="padding:12px">
              <div class="top-controls">
                <div class="search">
                  <input id="searchBox" class="form-control" placeholder="Search ID, name, phone or Amharic text..." />
                </div>
                <div class="controls">
                  <button id="btnBulkDelete" class="btn btn-danger"><i class="fa fa-trash"></i> Delete</button>
                  <button id="btnAddNew" class="btn btn-success"><i class="fa fa-plus"></i> Add</button>
                </div>
              </div>

              <div class="table-wrap">
                <table id="membersTable" >
                  <thead id="tableHead">
                    <!-- populated dynamically to preserve exact Amharic headers -->
                  </thead>
                  <tbody id="tableBody"></tbody>
                </table>
              </div>
              <div class="note" style="margin-top:8px">Tip: Import Excel with either 1 header row or 2 header rows (top + subheaders). Subcolumns under "የብር መጠን" like "ለመመዝገቢያ" and "ለሼር" are handled and displayed exactly.</div>
            </div>
          </div>

          <!-- Right: form for add/edit and file chooser -->
          <div class="card panel">
            <h3 style="margin:0 0 8px 0">Add / Edit Member</h3>
            <form id="memberForm" class="panel">
              <div><label>ተ.ቁ (ID)</label><input id="inputId" class="form-control" required></div>
              <div><label>ስም ዝርዝር (Full name)</label><input id="inputName" class="form-control" required></div>
              <div><label>ስልክ ቁጥር (Phone)</label><input id="inputPhone" class="form-control"></div>
              <div class="form-row">
                <div>
                  <label>የብር መጠን - ለመመዝገቢያ</label>
                  <input id="inputRegAmt" class="form-control" type="number" step="0.01" />
                </div>
                <div>
                  <label>የብር መጠን - ለሼር</label>
                  <input id="inputShareAmt" class="form-control" type="number" step="0.01" />
                </div>
              </div>
              <div><label>ድምር (Total)</label><input id="inputTotal" class="form-control" readonly></div>
              <div><label>ደረሰኝ ቁጥር (Receipt No.)</label><input id="inputReceipt" class="form-control"></div>

              <div class="form-actions">
                <button id="saveMemberBtn" type="submit" class="btn btn-primary"><i class="fa fa-save"></i> Save</button>
                <button id="resetFormBtn" type="button" class="btn btn-muted">Reset</button>
              </div>
            </form>

            <hr />
            <h4 style="margin:0 0 6px 0">Import / File</h4>
            <div class="note">Choose your Excel file (.xlsx). First sheet will be read. Two header rows supported.</div>
            <div style="display:flex;gap:8px;margin-top:8px">
              <button id="btnOpenFile" class="btn btn-muted"><i class="fa fa-upload"></i> Choose File</button>
              <input id="fileInput" type="file" accept=".xlsx,.xls" style="display:none" />
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Notifications -->
    <div id="toast" style="position:fixed;top:18px;right:18px;display:none;z-index:1400"></div>
  </div>

  <!-- modal backdrop/content -->
  <div id="modalBack" class="modal-back">
    <div class="modal card" id="modalContent" role="dialog" aria-modal="true"></div>
  </div>

<script>
/* -------------------------
   Storage keys & defaults
   ------------------------- */
const STORAGE_KEY = "mv_members_exact_amharic_v2";
const CRED_KEY = "mv_admin_creds_v2";

let members = [];                 // array of member objects
let headers = [];                 // array of header keys exactly as imported (Amharic)
let editingId = null;

/* default admin credentials */
const defaultCreds = { username: "admin", password: "admin123" };
if(!localStorage.getItem(CRED_KEY)) localStorage.setItem(CRED_KEY, JSON.stringify(defaultCreds));

/* helpers */
const $ = sel => document.querySelector(sel);

/* toast */
function toast(msg, type="success"){
  const t = document.getElementById("toast");
  t.innerHTML = `<div class="card" style="padding:12px;border-radius:10px;${type==='success'?'border-left:4px solid var(--success);':'border-left:4px solid var(--danger);'}">${msg}</div>`;
  t.style.display = "block";
  setTimeout(()=> t.style.display = "none", 3000);
}

/* load/save members */
function loadMembers(){ members = JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]"); }
function saveMembers(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(members)); }

/* render table header & body using headers[] and members[] */
const tableHead = document.getElementById("tableHead");
const tableBody = document.getElementById("tableBody");

function buildTableHead(){
  tableHead.innerHTML = "";
  if(!headers || headers.length === 0){
    // default header layout (if nothing imported yet)
    headers = ["select","ተ.ቁ","ደረሰኝ ቁጥር","ስም  ዝርዝር","የብር መጠን - ለመመዝገቢያ","የብር መጠን - ለሼር","ድምር","ስልክ ቁጥር"];
  }
  const tr = document.createElement("tr");
  headers.forEach((h,i)=>{
    const th = document.createElement("th");
    if(i===0){
      th.innerHTML = `<input id="selectAll" type="checkbox" />`;
      th.style.width = "40px";
    } else {
      th.textContent = h;
    }
    tr.appendChild(th);
  });
  // actions header
  const thActions = document.createElement("th");
  thActions.textContent = "Actions";
  tr.appendChild(thActions);

  tableHead.appendChild(tr);

  // hook selectAll event
  const selAll = document.getElementById("selectAll");
  if(selAll){
    selAll.addEventListener("change", e=>{
      document.querySelectorAll(".rowCheckbox").forEach(cb=> cb.checked = selAll.checked);
    });
  }
}

/* render rows */
function renderTable(filtered){
  if(!Array.isArray(filtered)) filtered = members;
  tableBody.innerHTML = "";
  filtered.forEach(m=>{
    const tr = document.createElement("tr");
    // first cell checkbox
    const firstTd = document.createElement("td");
    firstTd.className = "checkbox-center";
    firstTd.innerHTML = `<input class="rowCheckbox" data-id="${escapeHtml(m[headers[1]]||m.id||"")}" type="checkbox" />`;
    tr.appendChild(firstTd);

    // render columns from headers[1..]
    for(let i=1;i<headers.length;i++){
      const key = headers[i];
      const td = document.createElement("td");
      let val = m[key];
      if(val === undefined || val === null) val = "";
      // format numbers nicely
      if(!isNaN(val) && val !== "" && val !== " "){
        // still keep original if string contains amharic characters
        if(typeof val === "number") td.textContent = new Intl.NumberFormat().format(val);
        else {
          // if numeric string
          const num = Number(String(val).replace(/,/g,""));
          if(!isNaN(num)) td.textContent = new Intl.NumberFormat().format(num);
          else td.textContent = val;
        }
      } else {
        td.textContent = val;
      }
      tr.appendChild(td);
    }

    // actions
    const tdAct = document.createElement("td");
    tdAct.innerHTML = `
      <div style="display:flex;gap:6px">
        <button class="btn btn-muted btn-edit" data-id="${escapeHtml(m[headers[1]]||m.id||"")}"><i class="fa fa-edit"></i></button>
        <button class="btn btn-danger btn-delete" data-id="${escapeHtml(m[headers[1]]||m.id||"")}"><i class="fa fa-trash"></i></button>
      </div>
    `;
    tr.appendChild(tdAct);
    tableBody.appendChild(tr);
  });
}

/* escape html */
function escapeHtml(s){
  if(s === undefined || s === null) return "";
  return String(s).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");
}

/* ------------ login flow ------------- */
const loginForm = document.getElementById("loginForm");
const loginUser = document.getElementById("loginUser");
const loginPass = document.getElementById("loginPass");
const loginView = document.getElementById("loginView");
const appView = document.getElementById("appView");

loginForm.addEventListener("submit", e=>{
  e.preventDefault();
  const creds = JSON.parse(localStorage.getItem(CRED_KEY) || JSON.stringify(defaultCreds));
  if(loginUser.value.trim() === creds.username && loginPass.value === creds.password){
    loginView.style.display = "none";
    appView.style.display = "block";
    loadMembers();
    buildTableHead();
    renderTable();
    toast("Welcome, " + creds.username, "success");
  } else {
    toast("Invalid credentials", "error");
  }
});

/* logout */
document.getElementById("btnLogout").addEventListener("click", ()=>{
  if(!confirm("Logout?")) return;
  appView.style.display = "none";
  loginView.style.display = "block";
});

/* ========== Add / Edit member form ========== */
const inputId = document.getElementById("inputId");
const inputName = document.getElementById("inputName");
const inputPhone = document.getElementById("inputPhone");
const inputRegAmt = document.getElementById("inputRegAmt");
const inputShareAmt = document.getElementById("inputShareAmt");
const inputTotal = document.getElementById("inputTotal");
const inputReceipt = document.getElementById("inputReceipt");
const memberForm = document.getElementById("memberForm");

function computeTotal(){ 
  const a = parseFloat(inputRegAmt.value) || 0;
  const b = parseFloat(inputShareAmt.value) || 0;
  inputTotal.value = (a + b).toFixed(2);
}
inputRegAmt.addEventListener("input", computeTotal);
inputShareAmt.addEventListener("input", computeTotal);

memberForm.addEventListener("submit", e=>{
  e.preventDefault();
  const id = inputId.value.trim();
  if(!id){ toast("ID required", "error"); return; }

  // Build object with keys based on current headers if available.
  // We'll fill the keys matching common names, else fallback to common fields.
  const obj = {};
  // If headers exist and are typical, populate them; otherwise fill fallback fields
  if(headers && headers.length >= 2){
    // headers[1] expected to be the ID header (based on importer earlier)
    obj[headers[1]] = id;
    // try to find name header
    const nameKey = headers.find(h => h.includes("ስም") || h.includes("Name") || h.includes("ሙሉ"));
    const phoneKey = headers.find(h => h.includes("ስልክ") || h.includes("Phone"));
    const regKey = headers.find(h => h.includes("ለመመዝገቢያ") || h.includes("ለመመ"));
    const shareKey = headers.find(h => h.includes("ለሼር") || h.includes("ሼር"));
    const totalKey = headers.find(h => h.includes("ድምር") || h.includes("Total"));
    const receiptKey = headers.find(h => h.includes("ደረሰ") || h.includes("Receipt"));

    if(nameKey) obj[nameKey] = inputName.value.trim();
    if(phoneKey) obj[phoneKey] = inputPhone.value.trim();
    if(regKey) obj[regKey] = parseFloat(inputRegAmt.value) || 0;
    if(shareKey) obj[shareKey] = parseFloat(inputShareAmt.value) || 0;
    if(totalKey) obj[totalKey] = parseFloat(inputTotal.value) || ( (parseFloat(inputRegAmt.value)||0) + (parseFloat(inputShareAmt.value)||0) );
    if(receiptKey) obj[receiptKey] = inputReceipt.value.trim();

    // For any header not set, fill empty strings
    for(const h of headers.slice(1)){
      if(obj[h] === undefined) obj[h] = "";
    }
  } else {
    // fallback keys if headers missing
    obj["ተ.ቁ"] = id;
    obj["ስም  ዝርዝር"] = inputName.value.trim();
    obj["ስልክ ቁጥር"] = inputPhone.value.trim();
    obj["የብር መጠን - ለመመዝገቢያ"] = parseFloat(inputRegAmt.value) || 0;
    obj["የብር መጠን - ለሼር"] = parseFloat(inputShareAmt.value) || 0;
    obj["ድምር"] = parseFloat(inputTotal.value) || 0;
    obj["ደረሰኝ ቁጥር"] = inputReceipt.value.trim();
    // ensure headers reflect fallback
    headers = ["select","ተ.ቁ","ደረሰኝ ቁጥር","ስም  ዝርዝር","የብር መጠን - ለመመዝገቢያ","የብር መጠን - ለሼር","ድምር","ስልክ ቁጥር"];
  }

  // Save or update
  const idKey = headers[1];
  const memberId = obj[idKey] || id;
  const existingIndex = members.findIndex(m=> String(m[idKey]) === String(memberId));
  if(existingIndex >= 0 && (editingId === null || editingId !== memberId)){
    toast("Member ID already exists", "error");
    return;
  }
  if(editingId){ // update existing (matching editingId by idKey)
    const idx = members.findIndex(m=> String(m[headers[1]]) === String(editingId));
    if(idx !== -1){
      members[idx] = obj;
      toast("Member updated");
    } else {
      members.push(obj);
      toast("Member saved");
    }
  } else {
    members.push(obj);
    toast("Member added");
  }
  saveMembers();
  buildTableHead();
  renderTable();
  resetForm();
});

/* reset form */
function resetForm(){
  editingId = null;
  memberForm.reset();
  inputTotal.value = "";
  inputId.disabled = false;
  document.getElementById("saveMemberBtn").innerHTML = `<i class="fa fa-save"></i> Save`;
}

/* edit & delete handlers (delegated) */
tableBody.addEventListener("click", e=>{
  const edit = e.target.closest(".btn-edit");
  const del = e.target.closest(".btn-delete");
  if(edit){
    const id = edit.dataset.id;
    const idKey = headers[1];
    const m = members.find(x=> String(x[idKey]) === String(id));
    if(!m){ toast("Member not found","error"); return; }
    // populate form fields from matched keys
    editingId = id;
    inputId.value = m[idKey] || "";
    inputId.disabled = true;
    // best-effort mapping:
    const nameKey = headers.find(h => h.includes("ስም") || h.includes("Name") || h.includes("ሙሉ"));
    const phoneKey = headers.find(h => h.includes("ስልክ") || h.includes("Phone"));
    const regKey = headers.find(h => h.includes("ለመመዝገቢያ") || h.includes("Registration") || h.includes("ለመመ"));
    const shareKey = headers.find(h => h.includes("ለሼር") || h.includes("ሼር") || h.includes("Share"));
    const totalKey = headers.find(h => h.includes("ድምር") || h.includes("Total"));
    const receiptKey = headers.find(h => h.includes("ደረሰ") || h.includes("Receipt"));
    if(nameKey) inputName.value = m[nameKey] || "";
    if(phoneKey) inputPhone.value = m[phoneKey] || "";
    if(regKey) inputRegAmt.value = m[regKey] || "";
    if(shareKey) inputShareAmt.value = m[shareKey] || "";
    if(totalKey) inputTotal.value = m[totalKey] || "";
    if(receiptKey) inputReceipt.value = m[receiptKey] || "";
    document.getElementById("saveMemberBtn").innerHTML = `<i class="fa fa-save"></i> Update`;
    window.scrollTo({top:0,behavior:"smooth"});
    return;
  }
  if(del){
    const id = del.dataset.id;
    const idKey = headers[1];
    if(!confirm(`Delete member ${id}?`)) return;
    members = members.filter(x=> String(x[idKey]) !== String(id));
    saveMembers();
    renderTable();
    toast("Member deleted");
  }
});

/* bulk delete */
document.getElementById("btnBulkDelete").addEventListener("click", ()=>{
  const checked = Array.from(document.querySelectorAll(".rowCheckbox:checked")).map(cb=> cb.dataset.id);
  if(checked.length === 0){ toast("No rows selected","error"); return; }
  if(!confirm(`Delete ${checked.length} members?`)) return;
  const idKey = headers[1];
  members = members.filter(m=> !checked.includes(String(m[idKey])));
  saveMembers();
  renderTable();
  toast(`${checked.length} deleted`);
});

/* search */
document.getElementById("searchBox").addEventListener("input", e=>{
  const term = e.target.value.trim().toLowerCase();
  if(!term) { renderTable(); return; }
  const filtered = members.filter(m=>{
    return headers.slice(1).some(k=>{
      const v = (m[k]||"").toString().toLowerCase();
      return v.includes(term);
    });
  });
  renderTable(filtered);
});

/* ============= File import (handles 2 header rows) ============= */
const fileInput = document.getElementById("fileInput");
document.getElementById("btnOpenFile").addEventListener("click", ()=> fileInput.click());
document.getElementById("btnImport").addEventListener("click", ()=> fileInput.click());

fileInput.addEventListener("change", handleFile);

function handleFile(evt){
  const file = evt.target.files && evt.target.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = (e)=>{
    try{
      const data = new Uint8Array(e.target.result);
      // read workbook
      const wb = XLSX.read(data, {type:"array", cellText:true, cellDates:true});
      const sheetName = wb.SheetNames[0];
      const sheet = wb.Sheets[sheetName];
      // get rows as arrays to inspect first two rows
      const rows = XLSX.utils.sheet_to_json(sheet, {header:1, defval:""});
      if(rows.length === 0) { toast("Empty sheet","error"); return; }

      // Decide header rows: we assume exactly two header rows as you confirmed.
      const top = rows[0].map(c => (c||"").toString().trim());
      const sub = rows[1] ? rows[1].map(c => (c||"").toString().trim()) : [];

      // Build combined headers (preserve exact Amharic text)
      const maxCols = Math.max(top.length, sub.length);
      const combined = [];
      for(let c=0;c<maxCols;c++){
        const a = (top[c]||"").toString().trim();
        const b = (sub[c]||"").toString().trim();
        let key = "";
        if(a && b){
          key = `${a} - ${b}`;
        } else if(a){
          key = a;
        } else if(b){
          key = b;
        } else {
          key = `COL_${c+1}`;
        }
        combined.push(key);
      }

      // Now build JSON rows using combined keys and starting from row index 2
      const dataRows = XLSX.utils.sheet_to_json(sheet, {header: combined, range: 2, defval:""});

      // If the sheet actually only had 1 header row (not 2), fallback: detect if second row seems data (numbers vs text)
      // But you confirmed exactly two header rows, so we use combined keys.

      // Merge into members: preserve exact keys and values, avoid duplicate IDs if exists
      // We'll set headers for table as ["select", ...combined]
      headers = ["select", ...combined];

      // For each dataRow, ensure numeric strings parsed into numbers when possible
      let added = 0;
      dataRows.forEach(r=>{
        // pick id from first meaningful column: try 'ተ.ቁ' or first combined[0] or combined[1] etc.
        // But we want to preserve the full object keyed by combined keys.
        // We'll consider the primary id key to be combined[0] if it resembles 'ተ.ቁ' else second column maybe 'ID'.
        const idKeyGuess = combined.find(k => k.includes("ተ.ቁ") || /id/i.test(k)) || combined[0];
        const idVal = String(r[idKeyGuess]||`ID_${Date.now()}_${Math.random().toString(36).slice(2,5)}`).trim();
        // if duplicate id exists, skip/option to update - here skip to avoid overwriting:
        const exists = members.some(m=> String(m[idKeyGuess]) === idVal);
        if(!exists){
          // normalize numbers where appropriate (try to parse numeric strings)
          const normalized = {};
          combined.forEach(key=>{
            let v = r[key];
            // if it's a string that contains only digits, commas, or periods, try parse
            if(typeof v === "string"){
              const cleaned = v.replace(/,/g,"").trim();
              if(cleaned !== "" && !isNaN(cleaned)) v = Number(cleaned);
            }
            normalized[key] = v;
          });
          members.push(normalized);
          added++;
        } else {
          // optionally update existing rows — this implementation keeps existing
        }
      });

      saveMembers();
      buildTableHead();
      renderTable();
      toast(`Imported ${dataRows.length} rows (added ${added}).`);
    } catch(err){
      console.error(err);
      toast("Import failed: " + (err.message || err), "error");
    }
  };
  reader.readAsArrayBuffer(file);
  // reset input value so same file can be reselected later
  evt.target.value = "";
}

/* =========== Export to Excel (preserve exact headers) =========== */
document.getElementById("btnExport").addEventListener("click", ()=>{
  if(!members || members.length === 0){ toast("No data to export","error"); return; }
  // If headers not set, try infer
  const keys = headers && headers.length > 1 ? headers.slice(1) : Object.keys(members[0] || {});
  // create rows preserving header names
  const rows = members.map(m=>{
    const row = {};
    keys.forEach(k => row[k] = m[k] !== undefined ? m[k] : "");
    return row;
  });
  const ws = XLSX.utils.json_to_sheet(rows, {header: keys});
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Members");
  XLSX.writeFile(wb, "members_export.xlsx");
  toast("Exported members_export.xlsx");
});

/* ============= Settings modal ============= */
document.getElementById("btnSettings").addEventListener("click", ()=>{
  const creds = JSON.parse(localStorage.getItem(CRED_KEY) || JSON.stringify(defaultCreds));
  showModal(`
    <h3>Settings</h3>
    <div style="margin-top:10px">
      <label>Admin Username</label>
      <input id="setUser" class="form-control" value="${escapeHtml(creds.username)}"/>
    </div>
    <div style="margin-top:8px">
      <label>Admin Password</label>
      <input id="setPass" type="password" class="form-control" value="${escapeHtml(creds.password)}" />
    </div>
    <div class="form-actions" style="margin-top:12px">
      <button id="saveSettings" class="btn btn-primary">Save</button>
      <button id="closeModalBtn" class="btn btn-muted">Cancel</button>
    </div>
  `);
  document.getElementById("saveSettings").addEventListener("click", ()=>{
    const u = document.getElementById("setUser").value.trim();
    const p = document.getElementById("setPass").value;
    if(!u || !p){ alert("Username and password cannot be empty"); return; }
    localStorage.setItem(CRED_KEY, JSON.stringify({username:u,password:p}));
    toast("Credentials saved");
    closeModal();
  });
  document.getElementById("closeModalBtn").addEventListener("click", closeModal);
});

/* modal helpers */
const modalBack = document.getElementById("modalBack");
const modalContent = document.getElementById("modalContent");
function showModal(html){
  modalContent.innerHTML = html;
  modalBack.style.display = "flex";
}
function closeModal(){
  modalBack.style.display = "none";
  modalContent.innerHTML = "";
}
modalBack.addEventListener("click", e => { if(e.target === modalBack) closeModal(); });

/* utility - populate login username for convenience */
const stored = JSON.parse(localStorage.getItem(CRED_KEY) || JSON.stringify(defaultCreds));
document.getElementById("loginUser").value = stored.username || "";

/* initial default headers (so UI has columns before import) */
headers = ["select","ተ.ቁ","ደረሰኝ ቁጥር","ስም  ዝርዝር","የብር መጠን - ለመመዝገቢያ","የብር መጠን - ለሼር","ድምር","ስልክ ቁጥር"];
buildTableHead();
loadMembers();
renderTable();

</script>
</body>
</html>
